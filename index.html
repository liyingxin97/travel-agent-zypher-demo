<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tina Travel Agent</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .typing-dot {
      width: 6px;
      height: 6px;
      background-color: #555;
      border-radius: 50%;
      display: inline-block;
      margin: 0 2px;
      animation: blink 1.4s infinite both;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
      0% { opacity: .2; }
      20% { opacity: 1; }
      100% { opacity: .2; }
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 12px 0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      vertical-align: top;
    }
    th {
      background-color: #f3f4f6;
      font-weight: bold;
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen p-6 flex flex-col gap-6">

  <!-- Input -->
  <div class="bg-white shadow-lg rounded-2xl p-6">
    <h1 class="text-2xl font-bold mb-3">‚úàÔ∏è Travel Agent by Tina</h1>

    <textarea
      id="input"
      class="w-full h-40 p-4 border rounded-lg focus:ring-2 focus:ring-blue-500"
      placeholder="Example: Create a 5-day Japan travel itinerary with budget tips, food, transport, and daily schedule."
    ></textarea>

    <button
      id="run-btn"
      class="mt-4 w-40 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 rounded-lg"
    >
      Run Task
    </button>
  </div>

  <!-- Output -->
  <div class="bg-white shadow-lg rounded-2xl p-6 overflow-x-auto">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold">üß† Final Output</h2>
      <button
        id="download-btn"
        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm"
      >
        Download Output
      </button>
    </div>

    <div id="thinking" class="hidden text-gray-500 mb-4">
      <span>Assistant is thinking</span>
      <span class="typing-dot"></span>
      <span class="typing-dot"></span>
      <span class="typing-dot"></span>
    </div>

    <div id="final-output" class="text-gray-900 whitespace-pre-wrap"></div>
  </div>

  <script>
    let lastOutput = "";

    function showThinking(show) {
      document.getElementById("thinking").classList.toggle("hidden", !show);
    }

    async function runTask() {
      const prompt = document.getElementById("input").value.trim();
      if (!prompt) return;

      showThinking(true);
      document.getElementById("final-output").innerHTML = "";
      lastOutput = "";

      try {
        const res = await fetch("http://localhost:8000/run-task", {
          method: "POST",
          body: JSON.stringify({ prompt }),
          headers: { "Content-Type": "application/json" },
        });

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let fullText = "";

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          fullText += decoder.decode(value);
        }

        showThinking(false);

        const cleaned = cleanOutput(fullText, prompt);
        lastOutput = cleaned;

        const html = markdownToHTML(cleaned);
        document.getElementById("final-output").innerHTML = html;

      } catch (err) {
        showThinking(false);
        document.getElementById("final-output").textContent =
          "‚ùå Request failed: " + err;
      }
    }

    function cleanOutput(text, userPrompt) {
      return text
        // remove echo of system header
        .replace(/SYSTEM:[\s\S]*?USER:/, "")
        // remove code fences
        .replace(/```[\s\S]*?```/g, (m) => m.replace(/```/g, ""))
        .replace(/```/g, "")
        // remove user prompt echoed by Claude
        .replace(new RegExp(userPrompt.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), "gi"), "")
        // remove generic Claude filler:
        .replace(/Sure.*?table/gi, "")
        .replace(/Here'?s.*?(itinerary|table)/gi, "")
        .replace(/I'll create.*?for you/gi, "")
        .replace(/I will create.*?for you/gi, "")
        .replace(/Let me.*?for you/gi, "")
        .replace(/I have created.*?below/gi, "")
        .replace(/Agent Response/gi, "")
        .trim();
    }

    function markdownToHTML(md) {
      // Fix malformed table lines BEFORE parsing
      md = md
        .split("\n")
        .map((line) => {
          if (line.includes("|")) {
            if (!line.trim().startsWith("|")) line = "|" + line;
            if (!line.trim().endsWith("|")) line = line + " |";
          }
          return line;
        })
        .join("\n");

      // Convert markdown tables
      md = md.replace(
        /\|(.+?)\|\n\|([-\s|:]+)\|\n([\s\S]+?)(?=\n\n|$)/g,
        (match, header, sep, body) => {
          const headers = header
            .split("|")
            .map((h) => `<th>${h.trim()}</th>`)
            .join("");

          const rows = body
            .trim()
            .split("\n")
            .map((row) => {
              row = row.trim();
              if (!row.startsWith("|")) row = "|" + row;
              if (!row.endsWith("|")) row = row + "|";

              const cells = row
                .split("|")
                .slice(1, -1)
                .map((c) => `<td>${c.trim()}</td>`)
                .join("");
              return `<tr>${cells}</tr>`;
            })
            .join("");

          return `<table><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table>`;
        }
      );

      // Headings, lists, bold, breaks
      md = md
        .replace(/^### (.*)$/gm, "<h3 class='text-lg font-bold mt-4 mb-2'>$1</h3>")
        .replace(/^## (.*)$/gm, "<h2 class='text-xl font-bold mt-4 mb-2'>$1</h2>")
        .replace(/^# (.*)$/gm, "<h1 class='text-2xl font-bold mt-4 mb-2'>$1</h1>")
        .replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>")
        .replace(/^- (.*)$/gm, "<li class='ml-6'>‚Ä¢ $1</li>")
        .replace(/\n/g, "<br>");

      return md;
    }

    function downloadOutput() {
      if (!lastOutput) return alert("No output available to download!");

      const blob = new Blob([lastOutput], { type: "text/markdown" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "travel-output.md";
      a.click();

      URL.revokeObjectURL(url);
    }

    document.getElementById("run-btn").onclick = runTask;
    document.getElementById("download-btn").onclick = downloadOutput;
  </script>
</body>
</html>

